{"ast":null,"code":"\"use strict\";\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar readable_stream_1 = require(\"readable-stream\");\n\nvar noop = function () {\n  return undefined;\n};\n\nvar PostMessageStream =\n/** @class */\nfunction (_super) {\n  __extends(PostMessageStream, _super);\n\n  function PostMessageStream(_a) {\n    var name = _a.name,\n        target = _a.target,\n        targetWindow = _a.targetWindow;\n\n    var _this = _super.call(this, {\n      objectMode: true\n    }) || this;\n\n    _this._name = name;\n    _this._target = target;\n    _this._targetWindow = targetWindow || window;\n    _this._origin = targetWindow ? '*' : location.origin; // initialization flags\n\n    _this._init = false;\n    _this._haveSyn = false;\n    _this._onMessage = _this._onMessage.bind(_this);\n    window.addEventListener('message', _this._onMessage, false); // send syncorization message\n\n    _this._write('SYN', null, noop);\n\n    _this.cork();\n\n    return _this;\n  }\n\n  PostMessageStream.prototype._destroy = function () {\n    // console.log('PostMessageStream: destroy');\n    window.removeEventListener('message', this._onMessage, false);\n  };\n\n  PostMessageStream.prototype._onMessage = function (event) {\n    var msg = event.data; // validate message\n\n    if (this._origin !== '*' && event.origin !== this._origin) return;\n    if (event.source !== this._targetWindow) return;\n    if (typeof msg !== 'object') return;\n    if (msg.target !== this._name) return;\n    if (!msg.data) return;\n\n    if (!this._init) {\n      if (msg.data === 'SYN') {\n        this._haveSyn = true;\n\n        this._write('ACK', null, noop);\n      } else if (msg.data === 'ACK') {\n        this._init = true;\n\n        if (!this._haveSyn) {\n          this._write('ACK', null, noop);\n        }\n\n        this.uncork();\n      }\n    } else {\n      // forward message\n      try {\n        this.push(msg.data);\n      } catch (err) {\n        this.emit('error', err);\n      }\n    }\n  };\n\n  PostMessageStream.prototype._read = function () {\n    return undefined;\n  };\n\n  PostMessageStream.prototype._write = function (data, _encoding, cb) {\n    var message = {\n      target: this._target,\n      data: data\n    };\n\n    this._targetWindow.postMessage(message, this._origin);\n\n    cb(null);\n  };\n\n  return PostMessageStream;\n}(readable_stream_1.Duplex);\n\nexports.default = PostMessageStream;","map":{"version":3,"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AAEA,IAAMA,IAAI,GAAG;EACX,OAAOC,SAAP;AACD,CAFD;;AAeA;AAAA;AAAA;EAA+CC;;EAQ7C,2BAAYC,EAAZ,EAAmD;QAArCC,IAAI;QAAEC,MAAM;QAAEC,YAAY;;IAAxC,YACEC,kBAAM;MAAEC,UAAU,EAAE;IAAd,CAAN,KAA2B,IAD7B;;IAGEC,KAAI,CAACC,KAAL,GAAaN,IAAb;IACAK,KAAI,CAACE,OAAL,GAAeN,MAAf;IACAI,KAAI,CAACG,aAAL,GAAqBN,YAAY,IAAIO,MAArC;IACAJ,KAAI,CAACK,OAAL,GAAeR,YAAY,GAAG,GAAH,GAASS,QAAQ,CAACC,MAA7C,CANiD,CAQjD;;IACAP,KAAI,CAACQ,KAAL,GAAa,KAAb;IACAR,KAAI,CAACS,QAAL,GAAgB,KAAhB;IACAT,KAAI,CAACU,UAAL,GAAkBV,KAAI,CAACU,UAAL,CAAgBC,IAAhB,CAAqBX,KAArB,CAAlB;IAEAI,MAAM,CAACQ,gBAAP,CAAwB,SAAxB,EAAmCZ,KAAI,CAACU,UAAxC,EAA2D,KAA3D,EAbiD,CAcjD;;IACAV,KAAI,CAACa,MAAL,CAAY,KAAZ,EAAmB,IAAnB,EAAyBtB,IAAzB;;IACAS,KAAI,CAACc,IAAL;;;EACD;;EAEDC;IACE;IACAX,MAAM,CAACY,mBAAP,CAA2B,SAA3B,EAAsC,KAAKN,UAA3C,EAA8D,KAA9D;EACD,CAHD;;EAKAK,mDAAWE,KAAX,EAAmE;IACjE,IAAMC,GAAG,GAAGD,KAAK,CAACE,IAAlB,CADiE,CAGjE;;IACA,IAAI,KAAKd,OAAL,KAAiB,GAAjB,IAAwBY,KAAK,CAACV,MAAN,KAAiB,KAAKF,OAAlD,EAA2D;IAC3D,IAAIY,KAAK,CAACG,MAAN,KAAiB,KAAKjB,aAA1B,EAAyC;IACzC,IAAI,OAAOe,GAAP,KAAe,QAAnB,EAA6B;IAC7B,IAAIA,GAAG,CAACtB,MAAJ,KAAe,KAAKK,KAAxB,EAA+B;IAC/B,IAAI,CAACiB,GAAG,CAACC,IAAT,EAAe;;IAEf,IAAI,CAAC,KAAKX,KAAV,EAAiB;MACf,IAAIU,GAAG,CAACC,IAAJ,KAAa,KAAjB,EAAwB;QACtB,KAAKV,QAAL,GAAgB,IAAhB;;QACA,KAAKI,MAAL,CAAY,KAAZ,EAAmB,IAAnB,EAAyBtB,IAAzB;MACD,CAHD,MAGO,IAAI2B,GAAG,CAACC,IAAJ,KAAa,KAAjB,EAAwB;QAC7B,KAAKX,KAAL,GAAa,IAAb;;QACA,IAAI,CAAC,KAAKC,QAAV,EAAoB;UAClB,KAAKI,MAAL,CAAY,KAAZ,EAAmB,IAAnB,EAAyBtB,IAAzB;QACD;;QACD,KAAK8B,MAAL;MACD;IACF,CAXD,MAWO;MACL;MACA,IAAI;QACF,KAAKC,IAAL,CAAUJ,GAAG,CAACC,IAAd;MACD,CAFD,CAEE,OAAOI,GAAP,EAAY;QACZ,KAAKC,IAAL,CAAU,OAAV,EAAmBD,GAAnB;MACD;IACF;EACF,CA7BD;;EA+BAR;IACE,OAAOvB,SAAP;EACD,CAFD;;EAIAuB,+CACEI,IADF,EAEEM,SAFF,EAGEC,EAHF,EAGoC;IAElC,IAAMC,OAAO,GAAG;MACd/B,MAAM,EAAE,KAAKM,OADC;MAEdiB,IAAI,EAAEA;IAFQ,CAAhB;;IAIA,KAAKhB,aAAL,CAAmByB,WAAnB,CAA+BD,OAA/B,EAAwC,KAAKtB,OAA7C;;IACAqB,EAAE,CAAC,IAAD,CAAF;EACD,CAXD;;EAYF;AAAC,CA/ED,CAA+CG,wBAA/C","names":["noop","undefined","__extends","_a","name","target","targetWindow","_super","objectMode","_this","_name","_target","_targetWindow","window","_origin","location","origin","_init","_haveSyn","_onMessage","bind","addEventListener","_write","cork","PostMessageStream","removeEventListener","event","msg","data","source","uncork","push","err","emit","_encoding","cb","message","postMessage","readable_stream_1"],"sources":["../../src/extension/PostMessageStream.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}