{"ast":null,"code":"\"use strict\";\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.WebSocketClient = void 0;\n\nvar events_1 = require(\"events\");\n\nvar ws_1 = __importDefault(require(\"ws\"));\n\nvar hash_1 = require(\"../util/hash\");\n\nvar escapeSingleQuotes = function (str) {\n  return str.replace(/'/g, \"\\\\'\");\n};\n\nfunction makeQueryParams(query) {\n  var queryBuilder = [];\n\n  for (var _i = 0, _a = Object.keys(query); _i < _a.length; _i++) {\n    var key = _a[_i];\n    var queryItem = void 0;\n    var value = query[key]; // if value is scalar\n\n    if (!Array.isArray(value)) {\n      switch (typeof value) {\n        case 'number':\n          queryItem = \"\".concat(key, \"=\").concat(value);\n          break;\n\n        case 'string':\n          queryItem = \"\".concat(key, \"='\").concat(escapeSingleQuotes(value), \"'\");\n          break;\n\n        default:\n          // Date\n          queryItem = \"\".concat(key, \"=\").concat(value.toISOString());\n      }\n    } else {\n      switch (value[0]) {\n        case '>':\n        case '<':\n        case '<=':\n        case '>=':\n          if (typeof value[1] !== 'number') {\n            queryItem = \"\".concat(key).concat(value[0]).concat(value[1].toISOString());\n          } else {\n            queryItem = \"\".concat(key).concat(value[0]).concat(value[1]);\n          }\n\n          break;\n\n        case 'CONTAINS':\n          queryItem = \"\".concat(key, \" CONTAINS '\").concat(escapeSingleQuotes(value[1]), \"'\");\n          break;\n\n        case 'EXISTS':\n          queryItem = \"\".concat(key, \" EXISTS\");\n          break;\n      }\n    }\n\n    queryBuilder.push(queryItem);\n  }\n\n  return queryBuilder.join(' AND ');\n}\n/**\n * An object repesenting a connection to a Terra node's WebSocket RPC endpoint.\n * This allows for subscribing to Tendermint events through WebSocket.\n *\n * ### Events\n * **error** emitted when error raises\n * **connect** emitted after connection establishment\n * **reconnect** emitted upon every attempt of reconnection\n * **destroyed** emitted when socket has been destroyed\n *\n * ### Example\n *\n * ```ts\n * import { WebSocketClient } from '@terra-money/terra.js';\n *\n * const wsclient = new WebSocketClient(\"ws://localhost:26657/websocket\");\n *\n * wsclient.subscribe('NewBlock', {}, (data) => {\n *    console.log(data.value);\n *\n *    // close after receiving one block.\n *    wsclient.destroy();\n * })\n *\n * wsclient.subscribe(\n * 'Tx',\n *  {\n *    'message.action': 'send',\n *    'message.sender': ['CONTAINS', 'terra1...'],\n *  },\n *  (data) => {\n *    console.log(data.value);\n *\n *   // close after receiving one send Tx\n *   wsclient.destroy();\n * });\n *\n * wsclient.start();\n * ```\n */\n\n\nvar WebSocketClient =\n/** @class */\nfunction (_super) {\n  __extends(WebSocketClient, _super);\n  /**\n   * WebSocketClient constructor\n   * @param URL The WebSocket endpoint URL on the Tendermint RPC server.\n   *            Ex: ws://localhost:26657/websocket\n   * @param reconnectCount 0 for not to attempt reconnect, -1 for infinite, > 0 for number of times to attempt\n   * @param reconnectInterval retry interval in milliseconds\n   */\n\n\n  function WebSocketClient(URL, reconnectCount, reconnectInterval) {\n    if (reconnectCount === void 0) {\n      reconnectCount = 0;\n    }\n\n    if (reconnectInterval === void 0) {\n      reconnectInterval = 1000;\n    }\n\n    var _this = _super.call(this) || this;\n\n    _this.URL = URL;\n    _this.reconnectCount = reconnectCount;\n    _this.reconnectInterval = reconnectInterval;\n    _this._reconnectCount = _this.reconnectCount;\n    _this.isConnected = false;\n    _this.shouldAttemptReconnect = !!_this.reconnectInterval;\n    return _this;\n  }\n  /**\n   * Destroys class as well as socket\n   */\n\n\n  WebSocketClient.prototype.destroy = function () {\n    this.shouldAttemptReconnect = false;\n    this.reconnectTimeoutId && clearTimeout(this.reconnectTimeoutId);\n    this.socket && this.socket.close();\n  };\n\n  WebSocketClient.prototype.start = function () {\n    this.socket = new ws_1.default(this.URL);\n    this.socket.onopen = this.onOpen.bind(this);\n    this.socket.onmessage = this.onMessage.bind(this);\n    this.socket.onclose = this.onClose.bind(this);\n\n    this.socket.onerror = function () {\n      return undefined;\n    };\n  };\n\n  WebSocketClient.prototype.onOpen = function () {\n    this.isConnected = true;\n    this.emit('connect'); // reset reconnectCount after connection establishment\n\n    this._reconnectCount = this.reconnectCount;\n    this.socket.send(JSON.stringify({\n      jsonrpc: '2.0',\n      method: 'subscribe',\n      params: [this.queryParams],\n      id: 1\n    }));\n  };\n\n  WebSocketClient.prototype.onMessage = function (message) {\n    try {\n      var parsedData = JSON.parse(message.data.toString());\n\n      if (this.callback && parsedData.result && parsedData.result.query === this.queryParams) {\n        // this.emit('message', parsedData.result.data);\n        this.callback(parsedData.result.data);\n      }\n    } catch (err) {\n      this.emit('error', err);\n    }\n  };\n\n  WebSocketClient.prototype.onClose = function () {\n    var _this = this;\n\n    this.isConnected = false;\n\n    if (this.shouldAttemptReconnect && (this._reconnectCount > 0 || this._reconnectCount === -1)) {\n      if (this._reconnectCount !== -1) {\n        this._reconnectCount--;\n      }\n\n      this.reconnectTimeoutId && clearTimeout(this.reconnectTimeoutId);\n      this.reconnectTimeoutId = setTimeout(function () {\n        _this.emit('reconnect');\n\n        _this.start();\n      }, this.reconnectInterval);\n    } else {\n      this.emit('destroyed');\n    }\n  };\n\n  WebSocketClient.prototype.subscribe = function (event, query, callback) {\n    this.queryParams = makeQueryParams(__assign({\n      'tm.event': event\n    }, query));\n    this.callback = callback;\n  };\n\n  WebSocketClient.prototype.subscribeTx = function (query, callback) {\n    var newCallback = function (d) {\n      d.value.TxResult.txhash = (0, hash_1.hashToHex)(d.value.TxResult.tx);\n      return callback(d);\n    };\n\n    this.subscribe('Tx', query, newCallback);\n  };\n\n  return WebSocketClient;\n}(events_1.EventEmitter);\n\nexports.WebSocketClient = WebSocketClient;","map":{"version":3,"mappings":"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","names":["escapeSingleQuotes","str","replace","makeQueryParams","query","queryBuilder","keys","_i","key","queryItem","value","Array","isArray","concat","toISOString","push","join","__extends","URL","reconnectCount","reconnectInterval","_super","_this","_reconnectCount","isConnected","shouldAttemptReconnect","WebSocketClient","reconnectTimeoutId","clearTimeout","socket","close","ws_1","onopen","onOpen","bind","onmessage","onMessage","onclose","onClose","onerror","emit","send","JSON","stringify","jsonrpc","method","params","queryParams","id","message","parsedData","parse","data","toString","callback","result","err","setTimeout","start","event","newCallback","d","TxResult","txhash","tx","subscribe","events_1","exports"],"sources":["../../src/client/WebSocketClient.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}